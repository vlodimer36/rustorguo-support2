<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Rustorguo Support</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; margin-bottom: 20px; text-align: center; }
        .users-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .user-card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; cursor: pointer; transition: all 0.3s; background: #fafafa; }
        .user-card:hover { border-color: #007bff; background: #e3f2fd; }
        .user-card.selected { border-color: #007bff; background: #bbdefb; }
        .user-card.unread { border-left: 4px solid #ff4757; }
        .user-id { font-weight: bold; color: #007bff; margin-bottom: 5px; }
        .user-info { font-size: 14px; color: #666; }
        .unread-badge { background: #ff4757; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 10px; }
        
        .reply-section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 20px; border: 1px solid #ddd; }
        .reply-section h3 { margin-bottom: 15px; color: #333; }
        #reply-text { width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical; margin-bottom: 10px; }
        .btn { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .btn:hover { background: #0056b3; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        
        .messages { margin-top: 20px; }
        .message { padding: 10px; margin: 5px 0; border-radius: 5px; }
        .message.user { background: #e3f2fd; text-align: right; }
        .message.bot { background: #f1f8e9; text-align: left; }
        
        .loading { text-align: center; padding: 20px; color: #666; }
        .error { color: #ff4757; padding: 10px; background: #ffe6e6; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üë®‚Äçüíº –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ Rustorguo</h1>
        
        <div class="refresh-section">
            <button class="btn" onclick="loadUsers()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            <span style="margin-left: 10px; color: #666;">–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥</span>
        </div>
        
        <h2 style="margin: 20px 0;">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
        <div id="users-list" class="users-grid">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</div>
        </div>
        
        <div id="reply-section" class="reply-section" style="display: none;">
            <h3>üí¨ –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: <span id="current-user" style="color: #007bff;"></span></h3>
            
            <div id="user-messages" class="messages">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
            </div>
            
            <textarea id="reply-text" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç..."></textarea>
            <button class="btn" onclick="sendReply()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
            <span id="reply-status" style="margin-left: 10px;"></span>
        </div>
        
        <div id="error-message" class="error" style="display: none;"></div>
    </div>

    <script>
        const SERVER_URL = 'https://rustorguo-support.onrender.com';
        let selectedUserId = null;

        // Load users list
        async function loadUsers() {
            try {
                document.getElementById('users-list').innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</div>';
                
                const response = await fetch(`${SERVER_URL}/api/users`);
                const data = await response.json();
                
                if (data.success) {
                    if (data.users.length === 0) {
                        document.getElementById('users-list').innerHTML = '<div class="loading">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
                        return;
                    }
                    
                    const usersHtml = data.users.map(user => `
                        <div class="user-card ${user.unreadCount > 0 ? 'unread' : ''} ${user.userId === selectedUserId ? 'selected' : ''}" 
                             onclick="selectUser('${user.userId}')">
                            <div class="user-id">${user.userId}</div>
                            <div class="user-info">
                                –°–æ–æ–±—â–µ–Ω–∏–π: ${user.messageCount}
                                ${user.unreadCount > 0 ? `<span class="unread-badge">${user.unreadCount} –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö</span>` : ''}
                            </div>
                            <div class="user-info">
                                –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${user.lastActivity ? new Date(user.lastActivity).toLocaleString('ru-RU') : '–ù–µ—Ç'}
                            </div>
                        </div>
                    `).join('');
                    
                    document.getElementById('users-list').innerHTML = usersHtml;
                } else {
                    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message);
            }
        }

        // Select user and load messages
        async function selectUser(userId) {
            selectedUserId = userId;
            document.getElementById('current-user').textContent = userId;
            document.getElementById('reply-section').style.display = 'block';
            
            // Update selected style
            document.querySelectorAll('.user-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`.user-card[onclick="selectUser('${userId}')"]`).classList.add('selected');
            
            // Load user messages
            await loadUserMessages(userId);
        }

        // Load user messages
        async function loadUserMessages(userId) {
            try {
                document.getElementById('user-messages').innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>';
                
                const response = await fetch(`${SERVER_URL}/api/messages/${userId}`);
                const data = await response.json();
                
                if (data.success) {
                    if (data.messages.length === 0) {
                        document.getElementById('user-messages').innerHTML = '<div class="loading">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
                        return;
                    }
                    
                    const messagesHtml = data.messages.map(msg => `
                        <div class="message ${msg.from}">
                            <strong>${msg.from === 'user' ? 'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' : 'ü§ñ –ë–æ—Ç'}:</strong><br>
                            ${msg.text}<br>
                            <small>${new Date(msg.timestamp).toLocaleString('ru-RU')}</small>
                        </div>
                    `).join('');
                    
                    document.getElementById('user-messages').innerHTML = messagesHtml;
                } else {
                    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π: ' + error.message);
            }
        }

        // Send reply to user
        async function sendReply() {
            const replyText = document.getElementById('reply-text').value.trim();
            
            if (!replyText) {
                showError('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞');
                return;
            }
            
            if (!selectedUserId) {
                showError('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                return;
            }
            
            try {
                document.getElementById('reply-status').textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
                document.getElementById('reply-status').style.color = '#666';
                
                const response = await fetch(`${SERVER_URL}/api/send-reply`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: selectedUserId,
                        replyText: replyText
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('reply-status').textContent = '‚úÖ –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!';
                    document.getElementById('reply-status').style.color = 'green';
                    document.getElementById('reply-text').value = '';
                    
                    // Reload messages
                    await loadUserMessages(selectedUserId);
                    await loadUsers();
                    
                    // Clear status after 3 seconds
                    setTimeout(() => {
                        document.getElementById('reply-status').textContent = '';
                    }, 3000);
                } else {
                    showError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message);
            }
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Auto-refresh every 30 seconds
        setInterval(loadUsers, 30000);

        // Initial load
        loadUsers();
    </script>
</body>
</html>
